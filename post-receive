#!/bin/bash
set -euxo pipefail

# To use this script as a hook for continuous deployment, create a
# symlink by running the following command from the repository root:
# ln -snvf $(pwd)/post-receive .git/hooks/post-receive

WORKDIR=~/piplayer
ENV=.env.production

# From https://gist.github.com/deanrather/3697539
echo "Determining branch"
if ! [ -t 0 ]
then
  read -a ref
fi
BRANCH=$(sed 's,refs/heads/,,' <<< "${ref[2]}")

GIT_WORK_TREE="$WORKDIR" git checkout -f "$BRANCH"

if [[ "$BRANCH" == "deploy/production" ]] && [[ "$(hostname)" == "bier" ]]
then
  pushd "$WORKDIR"
  ! [[ "$(sudo docker ps | grep piplayer)" ]] || sudo docker-compose --env-file $ENV down
  CONTAINERS=$(sudo docker ps -aq)
  IMAGES=$(sudo docker images -q)
  ! [[ "$CONTAINERS" ]] || sudo docker rm $CONTAINERS
  ! [[ "$IMAGES" ]] || sudo docker rmi $IMAGES
  sudo bash ./run.sh $ENV
fi
